<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Support Chat - BandhanByPreeti</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
    background: #fafafa;
    display: flex; flex-direction: column;
  }
  #chat-container {
    max-width: 600px;
    margin: auto;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  #chat-header {
    padding: 15px;
    background: #d35400;
    color: white;
    font-weight: bold;
    font-size: 20px;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
  }
  #chat-messages {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background: #fff;
  }
  .message {
    margin-bottom: 15px;
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    font-size: 14px;
    line-height: 1.3;
  }
  .message.user {
    background: #d35400;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 2px;
  }
  .message.bot {
    background: #eee;
    color: #333;
    border-bottom-left-radius: 2px;
  }
  .message.admin {
    background: #3498db;
    color: white;
    border-bottom-left-radius: 2px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .admin-badge {
    background: #2980b9;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: bold;
    width: 18px;
    height: 18px;
    text-align: center;
    line-height: 18px;
  }
  .verified-tick {
    width: 16px; height: 16px;
    background: #2980b9;
    mask: url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.172l-3.95-3.95-1.414 1.414L9 19 21 7l-1.414-1.414z"/></svg>') no-repeat center;
    -webkit-mask: url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.172l-3.95-3.95-1.414 1.414L9 19 21 7l-1.414-1.414z"/></svg>') no-repeat center;
  }
  #input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ccc;
    background: #fff;
  }
  #message-input {
    flex-grow: 1;
    font-size: 16px;
    padding: 10px;
    border-radius: 18px;
    border: 1px solid #ccc;
    outline: none;
  }
  #send-btn {
    background: #d35400;
    border: none;
    color: white;
    padding: 0 20px;
    margin-left: 10px;
    border-radius: 18px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    transition: background 0.3s;
  }
  #send-btn:hover {
    background: #e67e22;
  }
</style>
</head>
<body>

<div id="chat-container">
  <div id="chat-header">Support Chat</div>
  <div id="chat-messages"></div>
  <div id="input-area">
    <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" />
    <button id="send-btn">Send</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js"></script>

<script>
  const firebaseConfig = {
   apiKey: "AIzaSyD2Dgr5K8IC3TzBP_x9Fsc3X0gMEd4xLww",
    authDomain: "bandhanbypreeti.firebaseapp.com",
    databaseURL: "https://bandhanbypreeti-default-rtdb.firebaseio.com",
    projectId: "bandhanbypreeti",
    storageBucket: "bandhanbypreeti.appspot.com",
    messagingSenderId: "880058352718",
    appId: "1:880058352718:web:3c5444ce629265467eef1f",
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const chatMessages = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');

  let currentUser = null;
  let caseNumber = null;
  let chatRef = null;
  let botHasSentInitialMessage = false;

  // Generate random case number (6 digits)
  function generateCaseNumber() {
    return Math.floor(100000 + Math.random() * 900000);
  }

  // Append message to chat box
  function appendMessage(text, sender = 'user') {
    const div = document.createElement('div');
    div.classList.add('message');
    if(sender === 'user') div.classList.add('user');
    else if(sender === 'bot') div.classList.add('bot');
    else if(sender === 'admin') {
      div.classList.add('admin');
      div.innerHTML = `
        <span>BandhanByPreeti Support</span>
        <span class="verified-tick" title="Verified Support"></span><br/>
        <span>${text}</span>
      `;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return;
    }
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Send a message
  async function sendMessage(text, sender = 'user') {
    if(!chatRef) return;
    const msgData = {
      text,
      sender,
      timestamp: Date.now()
    };
    await chatRef.push(msgData);
  }

  // On auth change
  auth.onAuthStateChanged(async user => {
    if(!user) {
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;

    // Check if user already has a support chat case
    const supportRef = db.ref('supportChats/' + currentUser.uid);
    const snapshot = await supportRef.once('value');

    if(snapshot.exists()) {
      caseNumber = snapshot.val().caseNumber;
      chatRef = supportRef.child('messages');
    } else {
      // Create a new case
      caseNumber = generateCaseNumber();
      await supportRef.set({
        caseNumber: caseNumber,
        userName: currentUser.displayName || currentUser.email || 'User',
        userId: currentUser.uid,
        adminReplied: false
      });
      chatRef = supportRef.child('messages');

      // Bot initial message
      await sendMessage(`Your case number #${caseNumber} has been created. Please tell your issue.`, 'bot');
      botHasSentInitialMessage = true;
    }

    // Listen for new messages
    chatRef.on('child_added', (data) => {
      const msg = data.val();
      if(msg.sender === 'admin') {
        // Mark adminReplied flag true to trigger badge in user UI (you can implement this badge trigger in dashboard or wherever)
        supportRef.update({ adminReplied: true });

        appendMessage(msg.text, 'admin');
      } else if(msg.sender === 'bot') {
        appendMessage(msg.text, 'bot');
      } else {
        appendMessage(msg.text, 'user');
      }
    });
  });

  // When user sends message
  sendBtn.addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if(!text) return;

    await sendMessage(text, 'user');
    messageInput.value = '';

    // After first user message, bot responds once
    if(botHasSentInitialMessage) {
      await sendMessage("Your issue has been forwarded to the support team. Youâ€™ll get a reply as soon as possible.", 'bot');
      botHasSentInitialMessage = false;
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // Also send message on Enter key
  messageInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
</script>

</body>
</html>
