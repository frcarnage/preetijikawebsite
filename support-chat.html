<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Support Chat - BandhanByPreeti</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    height: 100vh;
    background: #f9f9f9;
  }
  header {
    background: #9c27b0;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  #chat-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border: 1px solid #ccc;
  }
  #messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    list-style: none;
    margin: 0;
  }
  #messages li {
    margin-bottom: 1rem;
    max-width: 70%;
    padding: 0.5rem 1rem;
    border-radius: 15px;
    word-wrap: break-word;
  }
  .msg-user {
    background-color: #e1ffc7;
    align-self: flex-end;
    text-align: right;
  }
  .msg-support {
    background-color: #eee;
    align-self: flex-start;
    position: relative;
  }
  .msg-support .msg-sender-label {
    font-weight: bold;
    margin-bottom: 0.2rem;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .verified-tick {
    width: 16px;
    height: 16px;
    fill: #2196f3;
  }
  .msg-timestamp {
    font-size: 0.7rem;
    color: #666;
    margin-top: 0.3rem;
  }
  form {
    display: flex;
    border-top: 1px solid #ccc;
    padding: 0.5rem;
    background: #fafafa;
  }
  input[type="text"] {
    flex-grow: 1;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 25px;
    outline: none;
  }
  button {
    margin-left: 0.5rem;
    background: #9c27b0;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 0 1.5rem;
    font-weight: bold;
    cursor: pointer;
  }
  button:disabled {
    background: #ccc;
    cursor: default;
  }
</style>
</head>
<body>
<header>BandhanByPreeti Support Chat</header>
<div id="chat-container" role="main" aria-live="polite" aria-atomic="false">
  <ul id="messages" aria-label="Support chat messages"></ul>
  <form id="message-form" aria-label="Send a message to support">
    <input type="text" id="message-input" aria-required="true" placeholder="Type your message..." autocomplete="off" />
    <button type="submit" disabled>Send</button>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    push,
    onChildAdded,
    update,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "bandhanbypreeti.firebaseapp.com",
    databaseURL: "https://bandhanbypreeti-default-rtdb.firebaseio.com",
    projectId: "bandhanbypreeti",
    storageBucket: "bandhanbypreeti.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Elements
  const messagesList = document.getElementById("messages");
  const messageForm = document.getElementById("message-form");
  const messageInput = document.getElementById("message-input");
  const sendBtn = messageForm.querySelector("button");

  let user = null;
  let supportChatRef = null;
  let hasBotSentInitial = false;
  let caseNumber = null;

  // Escape HTML to prevent injection
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      return {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[m];
    });
  }

  // Format timestamp
  function formatTimestamp(ts) {
    return new Date(ts).toLocaleString();
  }

  // Append message to chat
  function appendMessage(msg) {
    const li = document.createElement("li");
    const senderIsSupport = msg.sender === "support";
    li.classList.add(senderIsSupport ? "msg-support" : "msg-user");

    const senderLabel = senderIsSupport
      ? `<div class="msg-sender-label">BandhanByPreeti Support
          <svg class="verified-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-label="Verified">
            <path d="M9 16.2l-3.5-3.5L4 14.2 9 19 20 8l-1.5-1.5z"/>
          </svg>
         </div>`
      : "";

    const timeStr = formatTimestamp(msg.timestamp || Date.now());

    li.innerHTML = `
      ${senderLabel}
      <div>${escapeHtml(msg.text)}</div>
      <div class="msg-timestamp">${timeStr}</div>
    `;
    messagesList.appendChild(li);
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  // Generate random 6-digit case number
  function generateCaseNumber() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // On user auth state change
  onAuthStateChanged(auth, async (currentUser) => {
    if (!currentUser) {
      alert("Please log in to use support chat.");
      window.location.href = "/login.html";
      return;
    }
    user = currentUser;
    supportChatRef = ref(db, `supportChats/${user.uid}`);

    // Check if support chat exists for user
    const chatSnapshot = await get(supportChatRef);
    if (!chatSnapshot.exists()) {
      // Create new support chat entry with case number
      caseNumber = generateCaseNumber();
      await set(supportChatRef, {
        caseNumber,
        lastMessageTimestamp: Date.now(),
        unreadByUser: 0,
        unreadByAdmin: 0,
      });

      // Send initial bot message
      await push(ref(db, `supportChats/${user.uid}/messages`), {
        sender: "bot",
        text: `Your case number #${caseNumber} has been created. Please tell your issue.`,
        timestamp: Date.now(),
      });
      hasBotSentInitial = true;
    } else {
      // If chat exists, get case number from DB
      const data = chatSnapshot.val();
      caseNumber = data.caseNumber || generateCaseNumber();
    }

    // Load existing messages
    loadMessages();

    // Listen for new messages
    onChildAdded(ref(db, `supportChats/${user.uid}/messages`), (snapshot) => {
      const msg = snapshot.val();
      appendMessage(msg);
    });
  });

  // Load messages once on startup (optional if you want)
  async function loadMessages() {
    messagesList.innerHTML = "";
    const messagesSnapshot = await get(ref(db, `supportChats/${user.uid}/messages`));
    if (messagesSnapshot.exists()) {
      const msgs = messagesSnapshot.val();
      Object.values(msgs).forEach(appendMessage);
    }
  }

  // Send user message
  messageForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    // Push user message
    await push(ref(db, `supportChats/${user.uid}/messages`), {
      sender: user.uid,
      text,
      timestamp: Date.now(),
    });

    // Update lastMessageTimestamp and unreadByAdmin count
    await update(supportChatRef, {
      lastMessageTimestamp: Date.now(),
      unreadByAdmin: (supportChatRef.unreadByAdmin || 0) + 1,
    });

    messageInput.value = "";
    sendBtn.disabled = true;

    // Bot replies only on first user message (once per session)
    if (hasBotSentInitial) {
      await push(ref(db, `supportChats/${user.uid}/messages`), {
        sender: "bot",
        text: "Your issue has been forwarded to the support team. Youâ€™ll get a reply as soon as possible.",
        timestamp: Date.now(),
      });
      hasBotSentInitial = false;
    }
  });

  messageInput.addEventListener("input", () => {
    sendBtn.disabled = messageInput.value.trim().length === 0;
  });
</script>
</body>
</html>
