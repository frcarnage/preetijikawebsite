<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search Matches - Preeti Shaadi</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; }
    label { margin-right: 10px; }
    input, select, button { padding: 6px; margin: 5px; }
    .profile-card { border: 1px solid #ccc; padding: 12px; margin: 12px 0; border-radius: 6px; }
    img { max-width: 100px; height: auto; border-radius: 50%; }
  </style>
</head>
<body>
  <h1>Find Matches</h1>
  <button id="logoutBtn">Logout</button>

  <form id="filter-form">
    <label>Gender:
      <select id="filter-gender">
        <option value="">Any</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </label>
    <label>Min Age: <input type="number" id="filter-min-age" min="18" max="100" /></label>
    <label>Max Age: <input type="number" id="filter-max-age" min="18" max="100" /></label>
    <label>Location: <input type="text" id="filter-location" placeholder="City or State" /></label>
    <button type="submit">Search</button>
  </form>

  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPzGXGIzSbDysU2COetHSeHTl_ZEuZx1Q",
      authDomain: "nice-ae434.firebaseapp.com",
      projectId: "nice-ae434",
      storageBucket: "nice-ae434.appspot.com",
      messagingSenderId: "880835929368",
      appId: "1:880835929368:web:23baf239b8804f0c1a6a6d",
      measurementId: "G-P9FQRZP2BF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resultsDiv = document.getElementById("results");
    const filterForm = document.getElementById("filter-form");
    const logoutBtn = document.getElementById("logoutBtn");

    // Logout button
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Please login to see matches.");
        window.location.href = "index.html";
      }
    });

    // Render profiles list
    function renderProfiles(profiles) {
      resultsDiv.innerHTML = "";
      if (profiles.length === 0) {
        resultsDiv.textContent = "No matches found.";
        return;
      }

      profiles.forEach(p => {
        const div = document.createElement("div");
        div.className = "profile-card";

        div.innerHTML = `
          <img src="${p.photoURL || 'https://via.placeholder.com/100'}" alt="${p.name}" />
          <h3>${p.name}, ${p.age}</h3>
          <p><strong>Gender:</strong> ${p.gender}</p>
          <p><strong>Location:</strong> ${p.location || 'N/A'}</p>
          <p><strong>Religion:</strong> ${p.religion || 'N/A'}</p>
          <p><strong>Bio:</strong> ${p.bio || ''}</p>
          <button onclick="sendRequest('${p.userId}', '${p.name}')">Send Contact Request</button>
        `;
        resultsDiv.appendChild(div);
      });
    }

    // Send contact request - stub for now
    window.sendRequest = function (userId, name) {
      alert(`Contact request sent to ${name}! (Feature coming soon)`);
      // Later you can add actual Firestore docs for requests
    };

    // Load all profiles initially
    async function loadProfiles(filters = {}) {
      const profilesRef = collection(db, "profiles");
      const snapshot = await getDocs(profilesRef);
      let profiles = [];
      snapshot.forEach(doc => {
        profiles.push(doc.data());
      });

      // Filter client side (you can improve with Firestore queries later)
      profiles = profiles.filter(p => {
        if (filters.gender && p.gender !== filters.gender) return false;
        if (filters.minAge && p.age < filters.minAge) return false;
        if (filters.maxAge && p.age > filters.maxAge) return false;
        if (filters.location && p.location) {
          if (!p.location.toLowerCase().includes(filters.location.toLowerCase())) return false;
        }
        return true;
      });

      renderProfiles(profiles);
    }

    // On form submit, get filters and reload profiles
    filterForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const filters = {
        gender: document.getElementById("filter-gender").value,
        minAge: parseInt(document.getElementById("filter-min-age").value) || null,
        maxAge: parseInt(document.getElementById("filter-max-age").value) || null,
        location: document.getElementById("filter-location").value.trim()
      };
      loadProfiles(filters);
    });

    // Load profiles on page load
    loadProfiles();

  </script>
</body>
</html>
