<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chats | BandhanByPreeti</title>
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <style>
    .chat-scroll {
      max-height: 80vh;
      overflow-y: auto;
    }
    .chat-input {
      outline: none;
      border: none;
      width: 100%;
    }
    /* Scrollbar styling */
    .chat-scroll::-webkit-scrollbar {
      width: 8px;
    }
    .chat-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header
    class="bg-black text-white p-4 text-center text-xl font-bold"
  >
    BandhanByPreeti - Messages
  </header>

  <main class="flex h-[calc(100vh-64px)]">
    <!-- Sidebar -->
    <aside
      class="w-full sm:w-1/3 md:w-1/4 border-r bg-white p-4 overflow-y-auto"
    >
      <h2 class="text-lg font-semibold mb-4">Chats</h2>
      <ul id="chatList" class="space-y-2"></ul>
    </aside>

    <!-- Chat Window -->
    <section class="flex-1 flex flex-col bg-gray-50">
      <div
        id="chatHeader"
        class="border-b p-4 font-semibold text-lg bg-white"
      >
        Select a user to chat
      </div>
      <div
        id="chatBox"
        class="flex-1 p-4 chat-scroll space-y-2 overflow-y-auto"
      ></div>
      <form
        id="chatForm"
        class="flex border-t bg-white p-4 items-center gap-2"
        style="display: none;"
      >
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          class="flex-1 px-3 py-2 border rounded chat-input"
          autocomplete="off"
          required
        />
        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Send
        </button>
      </form>
    </section>
  </main>

  <!-- Firebase & Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      addDoc,
      onSnapshot,
      doc,
      getDocs,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Dgr5K8IC3TzBP_x9Fsc3X0gMEd4xLww",
      authDomain: "bandhanbypreeti.firebaseapp.com",
      projectId: "bandhanbypreeti",
      storageBucket: "bandhanbypreeti.appspot.com",
      messagingSenderId: "880058352718",
      appId: "1:880058352718:web:3c5444ce629265467eef1f",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    let currentUser = null;
    let selectedUser = null;
    let chatId = null;
    let unsubscribeMessages = null; // to unsubscribe previous listener

    const chatList = document.getElementById("chatList");
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatHeader = document.getElementById("chatHeader");
    const messageInput = document.getElementById("messageInput");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      currentUser = user;

      // Load all profiles except current user
      loadChatList();
    });

    async function loadChatList() {
      chatList.innerHTML = ""; // clear old list

      const profilesSnapshot = await getDocs(collection(db, "profiles"));

      profilesSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        // Skip current user
        if (data.uid === currentUser.uid) return;

        // Create list item with user photo + name
        const li = document.createElement("li");
        li.className =
          "cursor-pointer hover:bg-gray-200 p-2 rounded flex items-center gap-3";

        // User photo (if photoURL exists)
        const img = document.createElement("img");
        img.src = data.photoURL || "https://via.placeholder.com/40?text=User";
        img.alt = data.name;
        img.className = "w-10 h-10 rounded-full object-cover";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = data.name;

        li.appendChild(img);
        li.appendChild(nameSpan);

        li.onclick = () => openChat(data);
        chatList.appendChild(li);
      });
    }

    function generateChatId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }

    function openChat(userData) {
      selectedUser = userData;
      chatHeader.textContent = `Chat with ${userData.name}`;
      chatForm.style.display = "flex";
      chatBox.innerHTML = "";

      chatId = generateChatId(currentUser.uid, userData.uid);

      // Unsubscribe previous listener if any
      if (unsubscribeMessages) unsubscribeMessages();

      const messagesRef = collection(db, "chats", chatId, "messages");
      const q = query(messagesRef, orderBy("timestamp"));

      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        chatBox.innerHTML = "";

        if (snapshot.empty) {
          // Show no messages placeholder
          const noMsg = document.createElement("div");
          noMsg.className = "text-center text-gray-500 mt-10";
          noMsg.textContent = "No messages yet. Start the conversation!";
          chatBox.appendChild(noMsg);
        } else {
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const bubble = document.createElement("div");
            bubble.className = `max-w-xs px-4 py-2 rounded text-white ${
              msg.sender === currentUser.uid
                ? "bg-blue-600 ml-auto"
                : "bg-gray-400"
            }`;
            bubble.textContent = msg.text;
            chatBox.appendChild(bubble);
          });
        }

        // Scroll to bottom
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const messagesRef = collection(db, "chats", chatId, "messages");
      await addDoc(messagesRef, {
        text,
        sender: currentUser.uid,
        timestamp: new Date(),
      });

      messageInput.value = "";
    });
  </script>
</body>
</html>
