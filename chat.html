<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chats | BandhanByPreeti</title>
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <style>
    .chat-scroll {
      max-height: 80vh;
      overflow-y: auto;
    }
    .chat-input {
      outline: none;
      border: none;
      width: 100%;
    }
    .typing-indicator {
      font-style: italic;
      color: #666;
      padding-left: 8px;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      margin-bottom: 0.3rem;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .chat-bubble.sent {
      background-color: #2563eb; /* blue-600 */
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }
    .chat-bubble.received {
      background-color: #d1d5db; /* gray-300 */
      color: #111827; /* gray-900 */
      border-bottom-left-radius: 0;
    }
    .timestamp {
      font-size: 0.65rem;
      color: #6b7280; /* gray-500 */
      position: absolute;
      bottom: -1.2rem;
      right: 0.5rem;
      user-select: none;
    }
    .chat-list-item {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
      gap: 0.5rem;
    }
    .chat-list-item:hover {
      background-color: #e5e7eb; /* gray-200 */
    }
    .chat-list-item.active {
      background-color: #bfdbfe; /* blue-200 */
    }
    .chat-list-avatar {
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      object-fit: cover;
      border: 2px solid transparent;
      transition: border-color 0.15s ease-in-out;
      flex-shrink: 0;
    }
    .chat-list-item.active .chat-list-avatar {
      border-color: #2563eb;
    }
    .unread-badge {
      background-color: #ef4444; /* red-500 */
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      border-radius: 9999px;
      text-align: center;
      margin-left: auto;
      user-select: none;
    }
    .emoji-picker-button {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 0.5rem;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header
    class="bg-black text-white p-4 text-center text-xl font-bold"
  >
    BandhanByPreeti - Messages
  </header>

  <main class="flex h-[calc(100vh-64px)]">
    <!-- Sidebar -->
    <aside
      class="w-full sm:w-1/3 md:w-1/4 border-r bg-white p-4 overflow-y-auto"
      id="sidebar"
    >
      <h2 class="text-lg font-semibold mb-4">Chats</h2>
      <ul id="chatList" class="space-y-2"></ul>
    </aside>

    <!-- Chat Window -->
    <section
      class="flex-1 flex flex-col bg-gray-50 relative"
    >
      <div
        id="chatHeader"
        class="border-b p-4 font-semibold text-lg bg-white flex items-center justify-between"
      >
        Select a user to chat
        <span id="typingIndicator" class="typing-indicator hidden">typing...</span>
      </div>
      <div
        id="chatBox"
        class="flex-1 p-4 chat-scroll space-y-2 overflow-y-auto"
      ></div>
      <form
        id="chatForm"
        class="flex border-t bg-white p-4 items-center gap-2"
        style="display: none;"
      >
        <button type="button" id="emojiButton" class="emoji-picker-button" title="Pick Emoji">ðŸ˜€</button>
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          class="flex-1 px-3 py-2 border rounded chat-input"
          autocomplete="off"
        />
        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Send
        </button>
      </form>
    </section>
  </main>

  <!-- Firebase & Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      getDocs,
      doc,
      addDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD2Dgr5K8IC3TzBP_x9Fsc3X0gMEd4xLww",
      authDomain: "bandhanbypreeti.firebaseapp.com",
      projectId: "bandhanbypreeti",
      storageBucket: "bandhanbypreeti.appspot.com",
      messagingSenderId: "880058352718",
      appId: "1:880058352718:web:3c5444ce629265467eef1f",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    // DOM elements
    const chatList = document.getElementById("chatList");
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatHeader = document.getElementById("chatHeader");
    const messageInput = document.getElementById("messageInput");
    const typingIndicator = document.getElementById("typingIndicator");
    const emojiButton = document.getElementById("emojiButton");

    let currentUser = null;
    let selectedUser = null;
    let chatId = null;
    let unsubscribeMessages = null;
    let typingTimeout = null;
    let activeChatListItem = null;

    // Emoji picker list
    const emojiList = ["ðŸ˜€", "ðŸ˜‚", "ðŸ˜", "ðŸ˜¢", "ðŸ˜¡", "ðŸ‘", "ðŸ™", "ðŸŽ‰", "ðŸ”¥", "ðŸ’”"];

    // Show emoji picker popup
    function showEmojiPicker() {
      if (document.getElementById("emojiPicker")) {
        document.getElementById("emojiPicker").remove();
        return;
      }
      const picker = document.createElement("div");
      picker.id = "emojiPicker";
      picker.style.position = "absolute";
      const rect = emojiButton.getBoundingClientRect();
      picker.style.bottom = (window.innerHeight - rect.top + 40) + "px";
      picker.style.left = rect.left + "px";
      picker.style.background = "white";
      picker.style.border = "1px solid #ccc";
      picker.style.padding = "8px";
      picker.style.borderRadius = "8px";
      picker.style.display = "flex";
      picker.style.gap = "8px";
      picker.style.zIndex = "1000";
      emojiList.forEach((emoji) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = emoji;
        btn.style.fontSize = "1.5rem";
        btn.style.background = "transparent";
        btn.style.border = "none";
        btn.style.cursor = "pointer";
        btn.addEventListener("click", () => {
          messageInput.value += emoji;
          messageInput.focus();
          picker.remove();
        });
        picker.appendChild(btn);
      });
      document.body.appendChild(picker);

      // Close picker on outside click
      const onBodyClick = (e) => {
        if (!picker.contains(e.target) && e.target !== emojiButton) {
          picker.remove();
          document.body.removeEventListener("click", onBodyClick);
        }
      };
      document.body.addEventListener("click", onBodyClick);
    }

    emojiButton.addEventListener("click", showEmojiPicker);

    // Format timestamp as HH:MM or date if older
    function formatTimestamp(timestamp) {
      if (!timestamp) return "";
      const date = timestamp.toDate();
      const now = new Date();
      const diff = now - date;
      if (diff < 86400000) {
        // Less than 24h show time HH:MM
        return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      } else {
        return date.toLocaleDateString();
      }
    }

    // Get chatId from two UIDs alphabetically
    function getChatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    // Render chat list item
    function renderChatListItem(user, lastMessage, unreadCount, isActive) {
      const li = document.createElement("li");
      li.className = "chat-list-item" + (isActive ? " active" : "");
      li.dataset.uid = user.uid;

      // Avatar
      const img = document.createElement("img");
      img.src = user.photoURL || "https://via.placeholder.com/40?text=U";
      img.alt = user.name + " avatar";
      img.className = "chat-list-avatar";

      // Info container
      const info = document.createElement("div");
      info.className = "flex-1 min-w-0";

      // Name
      const name = document.createElement("div");
      name.textContent = user.name || "Unknown";
      name.className = "font-semibold truncate";

      // Last message preview + timestamp
      const lastMsgDiv = document.createElement("div");
      lastMsgDiv.className = "text-sm text-gray-600 truncate flex justify-between items-center";

      const lastMsgText = document.createElement("span");
      lastMsgText.textContent = lastMessage?.text || "";
      lastMsgText.className = "truncate";

      const timeStampSpan = document.createElement("span");
      timeStampSpan.textContent = lastMessage?.timestamp ? formatTimestamp(lastMessage.timestamp) : "";
      timeStampSpan.className = "text-xs text-gray-400 ml-2 flex-shrink-0";

      lastMsgDiv.appendChild(lastMsgText);
      lastMsgDiv.appendChild(timeStampSpan);

      info.appendChild(name);
      info.appendChild(lastMsgDiv);

      // Unread badge
      const unreadBadge = document.createElement("div");
      if (unreadCount > 0) {
        unreadBadge.textContent = unreadCount > 9 ? "9+" : unreadCount;
        unreadBadge.className = "unread-badge";
      }

      li.appendChild(img);
      li.appendChild(info);
      if (unreadCount > 0) li.appendChild(unreadBadge);

      li.addEventListener("click", () => {
        if (activeChatListItem) activeChatListItem.classList.remove("active");
        li.classList.add("active");
        activeChatListItem = li;
        selectChat(user);
      });

      return li;
    }

    // Render messages in chatBox
    function renderMessages(messages) {
      chatBox.innerHTML = "";
      messages.forEach((msg) => {
        const div = document.createElement("div");
        div.className = "chat-bubble " + (msg.senderId === currentUser.uid ? "sent" : "received");
        div.textContent = msg.text;

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = formatTimestamp(msg.timestamp);
        div.appendChild(timeSpan);

        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Load chats list (all users except current)
    async function loadChats() {
      chatList.innerHTML = "";

      // Get all users except current
      const usersSnapshot = await getDocs(collection(db, "profiles"));
      const users = [];
      usersSnapshot.forEach((doc) => {
        if (doc.id !== currentUser.uid) {
          users.push({ uid: doc.id, ...doc.data() });
        }
      });

      // For each user, get last message and unread count
      for (const user of users) {
        const cId = getChatId(currentUser.uid, user.uid);

        const messagesRef = collection(db, "chats", cId, "messages");
        const q = query(messagesRef, orderBy("timestamp", "desc"),);

        // Fetch last message
        const msgSnapshot = await getDocs(q);
        const messages = [];
        msgSnapshot.forEach((doc) => messages.push(doc.data()));
        const lastMessage = messages[0] || null;

        // Count unread messages where recipient is current user and read !== true
        const unreadQuery = query(
          messagesRef,
          orderBy("timestamp", "desc")
        );
        const unreadSnapshot = await getDocs(unreadQuery);
        let unreadCount = 0;
        unreadSnapshot.forEach((doc) => {
          const msg = doc.data();
          if (
            msg.receiverId === currentUser.uid &&
            !msg.read
          ) {
            unreadCount++;
          }
        });

        const isActive = selectedUser && selectedUser.uid === user.uid;
        const li = renderChatListItem(user, lastMessage, unreadCount, isActive);
        chatList.appendChild(li);
      }
    }

    // Listen for new messages on active chat
    function listenMessages(cId) {
      if (unsubscribeMessages) unsubscribeMessages();

      const messagesRef = collection(db, "chats", cId, "messages");
      const q = query(messagesRef, orderBy("timestamp"));
      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        const messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        renderMessages(messages);

        // Mark unread messages as read where currentUser is receiver
        snapshot.docs.forEach(async (docSnap) => {
          const msg = docSnap.data();
          if (msg.receiverId === currentUser.uid && !msg.read) {
            await doc(db, "chats", cId, "messages", docSnap.id).update({ read: true });
          }
        });
      });
    }

    // Select chat with a user
    function selectChat(user) {
      selectedUser = user;
      chatHeader.textContent = user.name;
      chatForm.style.display = "flex";
      chatBox.innerHTML = "Loading messages...";
      chatId = getChatId(currentUser.uid, user.uid);

      listenMessages(chatId);
    }

    // Send message
    async function sendMessage(text) {
      if (!text.trim() || !selectedUser) return;

      const messagesRef = collection(db, "chats", chatId, "messages");
      await addDoc(messagesRef, {
        text: text.trim(),
        senderId: currentUser.uid,
        receiverId: selectedUser.uid,
        timestamp: serverTimestamp(),
        read: false,
      });

      messageInput.value = "";
    }

    // Typing indicator helpers (basic implementation)
    let typingRef = null;
    function setTyping(isTyping) {
      if (!selectedUser) return;
      const typingDoc = doc(db, "typingIndicators", chatId);
      if (isTyping) {
        // Add current user typing
        typingDoc.set(
          { [currentUser.uid]: true },
          { merge: true }
        );
      } else {
        typingDoc.set(
          { [currentUser.uid]: false },
          { merge: true }
        );
      }
    }

    // Listen for typing
    function listenTyping() {
      const typingDoc = doc(db, "typingIndicators", chatId);
      onSnapshot(typingDoc, (docSnap) => {
        if (!docSnap.exists()) {
          typingIndicator.classList.add("hidden");
          return;
        }
        const typingData = docSnap.data();
        // Show typing if other user is typing
        if (typingData[selectedUser.uid]) {
          typingIndicator.classList.remove("hidden");
        } else {
          typingIndicator.classList.add("hidden");
        }
      });
    }

    // Handle auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Redirect to login
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadChats();
    });

    // Handle form submit
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!messageInput.value.trim()) return;
      await sendMessage(messageInput.value);
      setTyping(false);
    });

    // Handle typing event with debounce
    let typingTimeoutId = null;
    messageInput.addEventListener("input", () => {
      setTyping(true);
      clearTimeout(typingTimeoutId);
      typingTimeoutId = setTimeout(() => {
        setTyping(false);
      }, 1500);
    });

  </script>
</body>
</html>
