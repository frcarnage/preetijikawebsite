<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chats | BandhanByPreeti</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .chat-scroll { max-height: 80vh; overflow-y: auto; }
    .chat-input { outline: none; border: none; width: 100%; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-black text-white p-4 text-center text-xl font-bold">BandhanByPreeti - Messages</header>

  <main class="flex h-[calc(100vh-64px)]">
    <!-- Sidebar -->
    <aside class="w-full sm:w-1/3 md:w-1/4 border-r bg-white p-4 overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Chats</h2>
      <ul id="chatList" class="space-y-2"></ul>
    </aside>

    <!-- Chat Window -->
    <section class="flex-1 flex flex-col bg-gray-50">
      <div id="chatHeader" class="border-b p-4 font-semibold text-lg bg-white">Select a user to chat</div>
      <div id="chatBox" class="flex-1 p-4 chat-scroll space-y-2 overflow-y-auto"></div>
      <form id="chatForm" class="flex border-t bg-white p-4 items-center gap-2" style="display: none;">
        <input type="text" id="messageInput" placeholder="Type your message..." class="flex-1 px-3 py-2 border rounded chat-input"/>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send</button>
      </form>
    </section>
  </main>

  <!-- Firebase & Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, addDoc, onSnapshot, doc, getDocs, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Dgr5K8IC3TzBP_x9Fsc3X0gMEd4xLww",
      authDomain: "bandhanbypreeti.firebaseapp.com",
      projectId: "bandhanbypreeti",
      storageBucket: "bandhanbypreeti.appspot.com",
      messagingSenderId: "880058352718",
      appId: "1:880058352718:web:3c5444ce629265467eef1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    let currentUser = null;
    let selectedUser = null;
    let chatId = null;

    const chatList = document.getElementById("chatList");
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatHeader = document.getElementById("chatHeader");
    const messageInput = document.getElementById("messageInput");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;

      const profilesSnapshot = await getDocs(collection(db, "profiles"));
      profilesSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.uid !== user.uid) {
          const li = document.createElement("li");
          li.className = "cursor-pointer hover:bg-gray-200 p-2 rounded";
          li.textContent = data.name;
          li.onclick = () => openChat(data);
          chatList.appendChild(li);
        }
      });
    });

    function generateChatId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }

    function openChat(userData) {
      selectedUser = userData;
      chatHeader.textContent = `Chat with ${userData.name}`;
      chatForm.style.display = "flex";
      chatBox.innerHTML = "";

      chatId = generateChatId(currentUser.uid, userData.uid);

      const messagesRef = collection(db, "chats", chatId, "messages");
      const q = query(messagesRef, orderBy("timestamp"));

      onSnapshot(q, (snapshot) => {
        chatBox.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const bubble = document.createElement("div");
          bubble.className = `max-w-xs px-4 py-2 rounded text-white ${
            msg.sender === currentUser.uid ? "bg-blue-600 ml-auto" : "bg-gray-400"
          }`;
          bubble.textContent = msg.text;
          chatBox.appendChild(bubble);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const messagesRef = collection(db, "chats", chatId, "messages");
      await addDoc(messagesRef, {
        text,
        sender: currentUser.uid,
        timestamp: new Date()
      });

      messageInput.value = "";
    });
  </script>
</body>
</html>
