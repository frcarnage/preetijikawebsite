<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chats | BandhanByPreeti</title>
  <link rel="icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-full md:w-1/3 lg:w-1/4 bg-white border-r overflow-y-auto">
      <div class="p-4 font-bold text-xl text-center border-b">Chats</div>
      <ul id="chatList" class="divide-y">
        <!-- Chat items will be loaded here -->
        <!-- Example:
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="selectChat('uid123', 'Priya Sharma')">
          <div class="font-medium">Priya Sharma</div>
          <div class="text-sm text-gray-500">Hello there!</div>
        </li>
        -->
      </ul>
    </aside>

    <!-- Chat Area -->
    <main class="flex-1 flex flex-col">
      <!-- Chat Header -->
      <div class="bg-white border-b p-4 font-semibold" id="chatHeader">
        Select a chat
      </div>

      <!-- Chat Messages -->
      <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2">
        <!-- Messages will appear here -->
      </div>

      <!-- Message Input -->
      <form id="messageForm" class="flex items-center p-4 bg-white border-t" style="display: none;">
        <input type="text" id="messageInput" placeholder="Type your message..." class="flex-1 p-2 border rounded mr-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
      </form>
    </main>
  </div>

  <!-- Firebase & Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Dgr5K8IC3TzBP_x9Fsc3X0gMEd4xLww",
      authDomain: "bandhanbypreeti.firebaseapp.com",
      projectId: "bandhanbypreeti",
      storageBucket: "bandhanbypreeti.firebasestorage.app",
      messagingSenderId: "880058352718",
      appId: "1:880058352718:web:3c5444ce629265467eef1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    let currentUser, currentChatUID = null;

    const chatList = document.getElementById('chatList');
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const chatHeader = document.getElementById('chatHeader');

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = 'login.html';
      currentUser = user;
      loadChatList();
    });

    async function loadChatList() {
      const snapshot = await getDocs(collection(db, 'profiles'));
      snapshot.forEach(docSnap => {
        const profile = docSnap.data();
        if (profile.uid !== currentUser.uid) {
          const li = document.createElement('li');
          li.className = 'p-4 hover:bg-gray-100 cursor-pointer';
          li.innerHTML = `<div class="font-medium">${profile.name}</div>
                          <div class="text-sm text-gray-500">${profile.city}</div>`;
          li.onclick = () => selectChat(profile.uid, profile.name);
          chatList.appendChild(li);
        }
      });
    }

    function selectChat(uid, name) {
      currentChatUID = uid;
      chatHeader.textContent = name;
      messageForm.style.display = 'flex';
      loadMessages(uid);
    }

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join('_');
    }

    function loadMessages(otherUID) {
      messagesDiv.innerHTML = '';
      const chatId = getChatId(currentUser.uid, otherUID);
      const messagesRef = collection(db, 'chats', chatId, 'messages');
      const q = query(messagesRef, orderBy('timestamp'));
      onSnapshot(q, snapshot => {
        messagesDiv.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.className = `p-2 max-w-xs rounded-lg ${msg.sender === currentUser.uid ? 'bg-blue-600 text-white self-end ml-auto' : 'bg-gray-200 text-black self-start mr-auto'}`;
          div.textContent = msg.text;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text || !currentChatUID) return;

      const chatId = getChatId(currentUser.uid, currentChatUID);
      const messagesRef = collection(db, 'chats', chatId, 'messages');
      await addDoc(messagesRef, {
        sender: currentUser.uid,
        text,
        timestamp: Date.now()
      });
      messageInput.value = '';
    });
  </script>

</body>
</html>
